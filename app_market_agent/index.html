<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Market Analyzer Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* Custom Monochrome Theme Adjustments */
        body {
            background-color: #f9fafb;
            color: #111827;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body class="font-sans antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-900 cursor-pointer" @click="goHome">
                    App Market Analyzer
                </h1>
                <nav class="flex space-x-4 text-sm text-gray-600">
                    <span v-if="currentView !== 'run_list'" @click="goHome"
                        class="hover:text-black cursor-pointer underline">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
                </nav>
            </div>
        </header>

        <!-- Main Content with Sidebar Layout -->
        <main class="flex-grow max-w-[90rem] mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex space-x-8">

            <!-- Sidebar Tabs -->
            <aside class="w-64 flex-shrink-0">
                <nav class="space-y-1">
                    <a href="#" @click.prevent="switchTab('run_list')"
                        :class="['group flex items-center px-3 py-2 text-sm font-medium rounded-md', currentView === 'run_list' || currentView === 'app_list' ? 'bg-gray-100 text-gray-900 border-l-4 border-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent']">
                        <span class="truncate">ë¶„ì„ ë¦¬í¬íŠ¸ í˜„í™©</span>
                    </a>

                    <a href="#" @click.prevent="switchTab('all_apps')"
                        :class="['group flex items-center px-3 py-2 text-sm font-medium rounded-md', currentView === 'all_apps' ? 'bg-gray-100 text-gray-900 border-l-4 border-gray-900' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-l-4 border-transparent']">
                        <span class="truncate">ì „ì²´ ìˆ˜ì§‘ ì•± ëª¨ì•„ë³´ê¸°</span>
                    </a>
                </nav>
            </aside>

            <!-- Dashboard Content Area -->
            <section class="flex-1 min-w-0">
                <!-- VIEW 1: Run History List -->
                <transition name="fade" mode="out-in">
                    <div v-if="currentView === 'run_list'" key="runs">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">ìµœê·¼ ë¶„ì„ ë¦¬í¬íŠ¸ í˜„í™©</h2>
                            <button @click="openKeywordModal" :disabled="isRunningPipeline"
                                class="bg-gray-800 hover:bg-black text-white font-bold py-2 px-4 rounded text-sm disabled:opacity-50 transition drop-shadow-sm">
                                {{ isRunningPipeline ? 'ë¶„ì„ ì‹¤í–‰ ì¤‘...' : 'ì‹ ê·œ ë¶„ì„ êµ¬ì„± ë° ì‹¤í–‰' }}
                            </button>
                        </div>
                        <div class="bg-white shadow overflow-hidden sm:rounded-md border border-gray-200">
                            <ul class="divide-y divide-gray-200">
                                <li v-for="run in runs" :key="run.id">
                                    <a href="#" @click.prevent="openRun(run.id)"
                                        class="block hover:bg-gray-50 p-4 sm:px-6 transition duration-150 ease-in-out">
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm font-semibold text-gray-900 truncate">ë¶„ì„ íšŒì°¨ #{{ run.id }}
                                            </p>
                                            <div class="ml-2 flex-shrink-0 flex">
                                                <p
                                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                    {{ run.total_apps_found }}ê°œì˜ íƒ€ê²Ÿ ë°œê²¬
                                                </p>
                                            </div>
                                        </div>
                                        <div class="mt-2 sm:flex sm:justify-between">
                                            <div class="sm:flex">
                                                <p class="flex items-center text-sm text-gray-500">
                                                    ì‹¤í–‰ ì¼ì‹œ: {{ formatDate(run.run_date) }}
                                                </p>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                                <li v-if="runs.length === 0" class="p-6 text-center text-gray-500">
                                    ì €ì¥ëœ ë¶„ì„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. (íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”)
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- VIEW 2: App List for a Run -->
                    <div v-else-if="currentView === 'app_list'" key="apps">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <button @click="currentView = 'run_list'" class="text-gray-500 hover:text-black">
                                        &larr; ë’¤ë¡œ
                                    </button>
                                    <h2 class="text-2xl font-bold text-gray-800 inline-block">ìœ ë§ íƒ€ê²Ÿ ì•± ë¦¬ìŠ¤íŠ¸</h2>
                                </div>
                                <span class="text-sm text-gray-500 ml-12">íšŒì°¨ #{{ selectedRunId }}</span>
                            </div>
                            <button @click="openRunLogs"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded text-sm transition">
                                Log ë³´ê¸°
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            <div v-for="app in apps" :key="app.id"
                                class="bg-white rounded-lg shadow border border-gray-200 p-5 flex flex-col hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-lg font-bold text-gray-900 line-clamp-1" :title="app.title">{{
                                        app.title
                                        }}</h3>
                                    <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded">{{
                                        app.platform.toUpperCase() }}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-2 truncate">ì¶œì²˜: {{ app.source_keyword }} | ID: {{
                                    app.app_store_id }}</p>

                                <div class="flex flex-wrap gap-1 mb-3">
                                    <span v-for="c in getAppCountries(app)" :key="c"
                                        class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-200 uppercase">{{
                                        c }}</span>
                                </div>

                                <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">{{
                                    getAppCountryMeta(app).description }}</p>

                                <div
                                    class="bg-gray-50 rounded p-3 text-xs text-gray-700 mb-4 space-y-1 border border-gray-100">
                                    <p><span class="font-semibold">ë‹ˆì¹˜ ë§ˆì¼“:</span> <span class="line-clamp-1"
                                            :title="app.eval_niche_market">{{ app.eval_niche_market }}</span></p>
                                    <p><span class="font-semibold">ìˆ˜ìµ ëª¨ë¸:</span> <span class="line-clamp-1"
                                            :title="app.eval_revenue_model">{{ app.eval_revenue_model }}</span></p>
                                    <p><span class="font-semibold">ë‹¨ìˆœì„±:</span> <span class="line-clamp-1"
                                            :title="app.eval_simplicity">{{ app.eval_simplicity }}</span></p>
                                </div>

                                <button @click="openAppDetail(app)"
                                    class="w-full bg-black text-white py-2 rounded text-sm font-semibold hover:bg-gray-800 transition">
                                    ìƒì„¸ ë¶„ì„ ë³´ê¸°
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW 3: All Collected Apps -->
                    <div v-else-if="currentView === 'all_apps'" key="allapps">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 inline-block mr-2">ì „ì²´ ìˆ˜ì§‘ ì•± ëª¨ì•„ë³´ê¸°</h2>
                                <span class="text-sm text-gray-500">ì§€ê¸ˆê¹Œì§€ ì„ ë³„ëœ ëª¨ë“  ìœ ë§ íƒ€ê²Ÿ ì•± (ì´ {{ allApps.length }}ê°œ)</span>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <!-- input -->
                                        <input type="checkbox" id="favorite-toggle" class="sr-only"
                                            v-model="showFavoritesOnly">
                                        <!-- line -->
                                        <div class="block bg-gray-300 w-10 h-6 rounded-full transition-colors"
                                            :class="{'bg-yellow-400': showFavoritesOnly}"></div>
                                        <!-- dot -->
                                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform transform"
                                            :class="{'translate-x-full': showFavoritesOnly}"></div>
                                    </div>
                                    <!-- label -->
                                    <div class="ml-3 text-sm font-bold text-gray-700">
                                        â­ ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            <div v-for="app in filteredAllApps" :key="'all_' + app.id"
                                class="bg-white rounded-lg shadow border border-gray-200 p-5 flex flex-col hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-lg font-bold text-gray-900 line-clamp-1" :title="app.title">{{
                                        app.title }}</h3>
                                    <span class="bg-gray-800 text-white text-xs px-2 py-1 rounded">{{
                                        app.platform.toUpperCase() }}</span>
                                </div>
                                <p class="text-xs text-gray-500 mb-2 truncate">
                                    ë°œê²¬ íšŒì°¨: #{{ app.run_history_id }} | ì¶œì²˜: {{ app.source_keyword }}
                                </p>

                                <div class="flex flex-wrap gap-1 mb-3">
                                    <span v-for="c in getAppCountries(app)" :key="c"
                                        class="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded border border-blue-200 uppercase">{{
                                        c }}</span>
                                </div>

                                <p class="text-sm text-gray-600 mb-4 line-clamp-3 flex-grow">{{
                                    getAppCountryMeta(app).description }}</p>

                                <div
                                    class="bg-gray-50 rounded p-3 text-xs text-gray-700 mb-4 space-y-1 border border-gray-100">
                                    <p><span class="font-semibold">ë‹ˆì¹˜ ë§ˆì¼“:</span> <span class="line-clamp-1"
                                            :title="app.eval_niche_market">{{ app.eval_niche_market }}</span></p>
                                    <p><span class="font-semibold">ìˆ˜ìµ ëª¨ë¸:</span> <span class="line-clamp-1"
                                            :title="app.eval_revenue_model">{{ app.eval_revenue_model }}</span></p>
                                    <p><span class="font-semibold">ë‹¨ìˆœì„±:</span> <span class="line-clamp-1"
                                            :title="app.eval_simplicity">{{ app.eval_simplicity }}</span></p>
                                </div>

                                <button @click="openAppDetail(app)"
                                    class="w-full bg-black text-white py-2 rounded text-sm font-semibold hover:bg-gray-800 transition">
                                    ìƒì„¸ ë¶„ì„ ë³´ê¸°
                                </button>
                            </div>
                            <div v-if="filteredAllApps.length === 0"
                                class="col-span-full p-6 text-center text-gray-500">
                                ì¡°ê±´ì— ë§ëŠ” ìˆ˜ì§‘ëœ ì•±ì´ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <!-- VIEW 4: App Detail Page -->
                    <div v-else-if="currentView === 'app_detail'" key="appdetail">
                        <div class="mb-6">
                            <button @click="currentView = selectedRunId ? 'app_list' : 'all_apps'"
                                class="text-gray-500 hover:text-black mb-4 flex items-center">
                                &larr; ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                            </button>

                            <!-- Header Info -->
                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center flex-grow">
                                        <h2 class="text-3xl font-bold text-gray-900 border-b border-gray-200 pb-2">
                                            {{ selectedApp.title }}
                                        </h2>
                                        <button @click="toggleFavorite(selectedApp)"
                                            class="ml-4 text-3xl focus:outline-none transition-transform hover:scale-110 drop-shadow-sm pb-2"
                                            :title="selectedApp.is_favorite ? 'ì¦ê²¨ì°¾ê¸° í•´ì œ' : 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'">
                                            {{ selectedApp.is_favorite ? 'â­' : 'â˜†' }}
                                        </button>
                                    </div>
                                    <span class="bg-gray-800 text-white text-sm px-3 py-1 rounded ml-4 shadow-sm">{{
                                        selectedApp.platform.toUpperCase() }}</span>
                                </div>

                                <!-- Country Tabs -->
                                <div class="flex space-x-2 border-b border-gray-200 mb-6">
                                    <button v-for="c in getAppCountries(selectedApp)" :key="'tab_'+c"
                                        @click="activeCountryTab = c"
                                        class="px-4 py-2 text-sm font-bold uppercase rounded-t-lg transition-colors border-b-2 -mb-px"
                                        :class="activeCountryTab === c ? 'border-gray-900 text-gray-900 bg-gray-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-100'">
                                        <span v-if="c==='us'">ğŸ‡ºğŸ‡¸ US</span>
                                        <span v-if="c==='kr'">ğŸ‡°ğŸ‡· KR</span>
                                        <span v-if="c!=='us' && c!=='kr'">{{ c }}</span>
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-gray-50 p-3 rounded border border-gray-100 text-center">
                                        <p class="text-xs text-gray-500 mb-1">ë³„ì  ë° ë¦¬ë·°</p>
                                        <p class="font-bold">â­ {{ getAppCountryMeta(selectedApp,
                                            activeCountryTab).average_rating ?
                                            Number(getAppCountryMeta(selectedApp,
                                            activeCountryTab).average_rating).toFixed(1)
                                            : 'N/A' }}
                                            <span class="text-xs font-normal">({{ getAppCountryMeta(selectedApp,
                                                activeCountryTab).rating_count ?
                                                getAppCountryMeta(selectedApp,
                                                activeCountryTab).rating_count.toLocaleString() : 0 }})</span>
                                        </p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded border border-gray-100 text-center">
                                        <p class="text-xs text-gray-500 mb-1">ê°€ê²©</p>
                                        <p class="font-bold">{{ getAppCountryMeta(selectedApp, activeCountryTab).price
                                            || 'N/A' }}</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded border border-gray-100 text-center">
                                        <p class="text-xs text-gray-500 mb-1">ì¶œì‹œì¼ (ì´ˆíšŒ)</p>
                                        <p class="font-bold">{{ getAppCountryMeta(selectedApp,
                                            activeCountryTab).release_date ?
                                            getAppCountryMeta(selectedApp,
                                            activeCountryTab).release_date.substring(0,10)
                                            : 'N/A' }}</p>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded border border-gray-100 text-center">
                                        <p class="text-xs text-gray-500 mb-1">ìš©ëŸ‰ / ì¹´í…Œê³ ë¦¬</p>
                                        <p class="font-bold text-sm">{{ getAppCountryMeta(selectedApp,
                                            activeCountryTab).file_size_bytes || 'Unknown' }} <br><span
                                                class="text-xs font-normal text-gray-600">{{
                                                getAppCountryMeta(selectedApp, activeCountryTab).primary_genre ||
                                                'Unknown' }}</span></p>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h3 class="text-lg font-bold text-gray-800 mb-2">ì•± ì„¤ëª…</h3>
                                    <div
                                        class="bg-gray-50 p-4 rounded text-sm text-gray-700 whitespace-pre-wrap max-h-48 overflow-y-auto border border-gray-200">
                                        {{ getAppCountryMeta(selectedApp, activeCountryTab).description }}
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-lg font-bold text-gray-800 mb-2">1ì°¨ AI ì„ ì • ì‚¬ìœ </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="bg-indigo-50 border border-indigo-100 p-3 rounded">
                                            <p class="text-xs font-bold text-indigo-800 mb-1">ë‹ˆì¹˜ ë§ˆì¼“ ì—¬ë¶€</p>
                                            <p class="text-sm text-gray-800">{{ selectedApp.eval_niche_market }}</p>
                                        </div>
                                        <div class="bg-green-50 border border-green-100 p-3 rounded">
                                            <p class="text-xs font-bold text-green-800 mb-1">ìˆ˜ìµ ëª¨ë¸ êµ¬ì¡°</p>
                                            <p class="text-sm text-gray-800">{{ selectedApp.eval_revenue_model }}</p>
                                        </div>
                                        <div class="bg-blue-50 border border-blue-100 p-3 rounded">
                                            <p class="text-xs font-bold text-blue-800 mb-1">ê¸°ëŠ¥ ë‹¨ìˆœì„±</p>
                                            <p class="text-sm text-gray-800">{{ selectedApp.eval_simplicity }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Deep Analysis Section -->
                            <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                                <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-2">
                                    <h3 class="text-xl font-bold text-gray-900">ğŸ” ì‹¬ì¸µ ë¦¬ë·° ì—­ê¸°íš ë¶„ì„</h3>
                                    <span v-if="appDetailData.status === 'collected'"
                                        class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">
                                        {{ formatDate(appDetailData.collection_date) }} ìˆ˜ì§‘ ì™„ë£Œë¨
                                    </span>
                                </div>

                                <!-- State: Not Collected -->
                                <div v-if="appDetailData.status === 'not_collected' && !isCollecting"
                                    class="text-center py-16 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
                                    <p class="text-gray-500 mb-4">ì•„ì§ ì´ ì•±ì— ëŒ€í•œ ë¶ˆë§Œ ë¦¬ë·°(1~3ì ) í¬ë¡¤ë§ ë° ì—­ê¸°íš ë¶„ì„ì´ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                                    <button @click="collectDetail" :disabled="isCollecting"
                                        class="bg-black hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow-md transition disabled:opacity-50 text-lg">
                                        ì‹¬ì¸µ ë¶„ì„ ìˆ˜ì§‘ ì‹œì‘í•˜ê¸°
                                    </button>
                                </div>

                                <!-- State: Collecting -->
                                <div v-else-if="isCollecting"
                                    class="text-center py-16 bg-gray-50 border border-gray-200 rounded-lg animate-pulse">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-4">
                                    </div>
                                    <p class="text-gray-800 font-bold mb-2 text-lg">ë¦¬ë·° í¬ë¡¤ë§ ë° LLM ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                                    <p class="text-sm text-gray-500">API í˜¸ì¶œ ìƒí™©ì— ë”°ë¼ ì•½ 10~30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                </div>

                                <!-- State: Collected & Ready -->
                                <div v-else-if="appDetailData.status === 'collected'" class="space-y-6">
                                    <div class="bg-red-50 p-5 rounded-lg border border-red-100 shadow-sm">
                                        <h4 class="font-bold text-red-800 mb-3 border-b border-red-200 pb-2 text-lg">ğŸš¨
                                            ìœ ì € ë¶ˆë§Œ ì‚¬í•­
                                            (Pain Points)</h4>
                                        <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">{{
                                            (appDetailData.country_data && appDetailData.country_data[activeCountryTab])
                                            ? appDetailData.country_data[activeCountryTab].pain_points : 'ë°ì´í„° ì—†ìŒ'
                                            }}</p>
                                    </div>

                                    <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-100 shadow-sm">
                                        <h4
                                            class="font-bold text-yellow-800 mb-3 border-b border-yellow-200 pb-2 text-lg">
                                            ğŸ’¡ ì‹ ê·œ ê¸°ëŠ¥
                                            ìš”êµ¬ (Requested Features)</h4>
                                        <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">{{
                                            (appDetailData.country_data && appDetailData.country_data[activeCountryTab])
                                            ? appDetailData.country_data[activeCountryTab].requested_features : 'ë°ì´í„° ì—†ìŒ'
                                            }}</p>
                                    </div>

                                    <div class="mt-8">
                                        <h4 class="font-bold text-gray-800 mb-3">ì°¸ê³ : ì›ë¬¸ ë¦¬ë·° ìƒ˜í”Œ (í¬ë¡¤ë§ëœ 1~3ì  ë¦¬ë·° ì¼ë¶€)</h4>
                                        <div
                                            class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50">
                                            <ul class="divide-y divide-gray-200">
                                                <li v-for="(review, index) in ((appDetailData.country_data && appDetailData.country_data[activeCountryTab]) ? appDetailData.country_data[activeCountryTab].raw_reviews_data : [])"
                                                    :key="index" class="p-4 text-sm hover:bg-gray-100 transition">
                                                    <span class="font-bold text-gray-900 mr-2">â­ï¸ {{ review.rating
                                                        }}</span>
                                                    <span class="text-gray-700">{{ review.review }}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </section>
        </main>

        <!-- VIEW 5: Log Modal -->
        <div v-if="logModalOpen" class="fixed inset-0 z-20 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
            aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="logModalOpen = false">
                </div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white rounded-lg text-left shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full max-h-[90vh] flex flex-col">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 flex-shrink-0">
                        <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì „ì²´ ë¡œê·¸ (íšŒì°¨ #{{ selectedRunId
                            }})</h3>
                    </div>
                    <div class="bg-gray-900 text-green-400 p-4 font-mono text-xs overflow-y-auto flex-grow whitespace-pre-wrap border-y border-gray-700 m-0 rounded-none w-full text-left"
                        style="min-height: 50vh;">
                        {{ runLogData }}
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse flex-shrink-0">
                        <button type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm"
                            @click="logModalOpen = false">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 6: Keyword Selection Modal -->
        <div v-if="keywordSelectModalOpen" class="fixed inset-0 z-30 overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                    @click="keywordSelectModalOpen = false"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white rounded-lg text-left shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
                    <div class="bg-white px-6 pt-6 pb-4 flex-shrink-0 border-b border-gray-200">
                        <h3 class="text-xl leading-6 font-bold text-gray-900 mb-4">ë¶„ì„í•  êµ­ê°€ ì„ íƒ</h3>
                        <div class="flex gap-4 mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" value="us" v-model="selectedCountries"
                                    class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm font-medium text-gray-700">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ (US)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="kr" v-model="selectedCountries"
                                    class="mr-2 rounded text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm font-medium text-gray-700">ğŸ‡°ğŸ‡· í•œêµ­ (KR)</span>
                            </label>
                        </div>
                        <h3 class="text-xl leading-6 font-bold text-gray-900 mb-2">ë¶„ì„í•  íƒ€ê²Ÿ ë‹ˆì¹˜ í‚¤ì›Œë“œ ì„¤ì •</h3>
                        <p class="text-sm text-gray-500">
                            ì•± ë§ˆì¼“ ìŠ¤í† ì–´ë¥¼ íƒìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•˜ë©°, ì„ íƒí•˜ì§€ ì•Šì„ ê²½ìš° ì „ì²´ ì¤‘ ë¬´ì‘ìœ„ 3ê°œê°€ í• ë‹¹ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="p-6 overflow-y-auto bg-gray-50">
                        <div class="flex flex-wrap gap-3">
                            <button v-for="kw in availableKeywords" :key="kw" @click="toggleKeyword(kw)" :class="['px-4 py-2 rounded-full border text-sm font-semibold transition drop-shadow-sm flex items-center', 
                                    selectedKeywords.includes(kw) ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'
                                ]" :disabled="!selectedKeywords.includes(kw) && selectedKeywords.length >= 3">
                                {{ kw }}
                                <span v-if="selectedKeywords.includes(kw)" class="ml-2 font-bold opacity-80">Ã—</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white px-6 py-4 sm:flex sm:flex-row-reverse border-t border-gray-200 rounded-b-lg">
                        <button type="button"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-black text-base font-medium text-white hover:bg-gray-800 focus:outline-none sm:ml-3 sm:w-auto text-sm"
                            @click="startPipelineWithKeywords">
                            {{ selectedKeywords.length > 0 ? selectedKeywords.length + 'ê°œ í‚¤ì›Œë“œë¡œ ë¶„ì„ ì‹œì‘' : 'ë¬´ì‘ìœ„ í‚¤ì›Œë“œë¡œ ë¶„ì„ ì‹œì‘'
                            }}
                        </button>
                        <button type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto text-sm"
                            @click="keywordSelectModalOpen = false">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        const API_BASE = '/api';

        createApp({
            data() {
                return {
                    currentView: 'run_list', // 'run_list', 'app_list', 'all_apps', 'app_detail'
                    runs: [],
                    apps: [],
                    allApps: [],
                    selectedRunId: null,

                    selectedApp: null,
                    appDetailData: { status: 'not_collected' },
                    isCollecting: false,
                    isRunningPipeline: false,

                    logModalOpen: false,
                    runLogData: '',

                    // V7: Dynamic Keywords
                    keywordSelectModalOpen: false,
                    availableKeywords: [
                        "ADHD Planner", "Visual Timer", "Minimalist tracker",
                        "Couple budget", "Neurodivergent focus", "Pomodoro study",
                        "Freelance invoice", "Receipt tracker", "Pet journal",
                        "Digital detox", "Mood tracker", "Baby sleep",
                        "Intermittent fasting", "Plant care", "Habit builder",
                        "Language flashcards", "Workout logger", "Medication reminder",
                        "Subscription manager", "Flight tracker"
                    ],
                    selectedKeywords: [],

                    // V8: Favorites
                    showFavoritesOnly: false,

                    // V9: Multi-Country
                    selectedCountries: ['us'],
                    activeCountryTab: 'us',

                    pipelineInterval: null
                }
            },
            computed: {
                filteredAllApps() {
                    if (this.showFavoritesOnly) {
                        return this.allApps.filter(app => app.is_favorite);
                    }
                    return this.allApps;
                }
            },
            mounted() {
                this.fetchRuns();
                this.checkPipelineStatus().then(() => {
                    if (this.isRunningPipeline) {
                        this.pollPipelineStatus();
                    }
                });
            },
            methods: {
                async checkPipelineStatus() {
                    try {
                        const res = await fetch(`${API_BASE}/pipeline_status`);
                        const data = await res.json();
                        this.isRunningPipeline = data.is_running;
                        if (!this.isRunningPipeline && this.pipelineInterval) {
                            clearInterval(this.pipelineInterval);
                            this.pipelineInterval = null;
                            this.fetchRuns(); // Auto-refresh when finished
                        }
                    } catch (e) {
                        console.error('Failed to check pipeline status', e);
                    }
                },
                pollPipelineStatus() {
                    if (this.pipelineInterval) clearInterval(this.pipelineInterval);
                    this.pipelineInterval = setInterval(this.checkPipelineStatus, 3000);
                },
                getAppCountryMeta(app, countryCode) {
                    if (!app || !app.country_data) return {};
                    if (countryCode && app.country_data[countryCode]) return app.country_data[countryCode];
                    // Fallback to the first available country
                    const keys = Object.keys(app.country_data);
                    if (keys.length > 0) return app.country_data[keys[0]];
                    return {};
                },
                getAppCountries(app) {
                    if (!app || !app.country_data) return [];
                    return Object.keys(app.country_data);
                },
                goHome() {
                    this.currentView = 'run_list';
                    this.selectedRunId = null;
                    this.fetchRuns();
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const d = new Date(dateString);
                    return d.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                },
                async fetchRuns() {
                    try {
                        const res = await fetch(`${API_BASE}/viewlist`);
                        this.runs = await res.json();
                    } catch (e) {
                        console.error("Failed to fetch runs", e);
                    }
                },
                async fetchAllApps() {
                    try {
                        const res = await fetch(`${API_BASE}/viewallapps`);
                        this.allApps = await res.json();
                    } catch (e) {
                        console.error("Failed to fetch all apps", e);
                    }
                },
                switchTab(tabName) {
                    this.currentView = tabName;
                    if (tabName === 'run_list') {
                        this.fetchRuns();
                    } else if (tabName === 'all_apps') {
                        this.fetchAllApps();
                    }
                },
                async openRun(runId) {
                    this.selectedRunId = runId;
                    this.currentView = 'app_list';
                    try {
                        const res = await fetch(`${API_BASE}/viewapplist?run_id=${runId}`);
                        this.apps = await res.json();
                    } catch (e) {
                        console.error("Failed to fetch app list", e);
                    }
                },
                async openAppDetail(app) {
                    this.selectedApp = app;
                    const countries = this.getAppCountries(app);
                    if (countries.length > 0) {
                        this.activeCountryTab = countries[0];
                    }
                    this.currentView = 'app_detail';
                    this.appDetailData = { status: 'not_collected' };
                    this.isCollecting = false;

                    try {
                        const res = await fetch(`${API_BASE}/viewappinfo?app_id=${app.id}`);
                        this.appDetailData = await res.json();
                    } catch (e) {
                        console.error("Failed to fetch app info", e);
                    }
                },
                async toggleFavorite(app) {
                    try {
                        const res = await fetch(`${API_BASE}/toggle_favorite?app_id=${app.id}`, {
                            method: 'POST'
                        });
                        const result = await res.json();
                        if (result.status === 'success') {
                            app.is_favorite = result.is_favorite;

                            // Update the main reactive lists to reflect state changes smoothly
                            const runListApp = this.apps.find(a => a.id === app.id);
                            if (runListApp) runListApp.is_favorite = result.is_favorite;

                            const allListApp = this.allApps.find(a => a.id === app.id);
                            if (allListApp) allListApp.is_favorite = result.is_favorite;

                            if (result.is_favorite) {
                                alert("ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ â­");
                            } else {
                                alert("ì¦ê²¨ì°¾ê¸°ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤ â˜†");
                            }
                        } else {
                            alert("ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: " + result.detail);
                        }
                    } catch (e) {
                        alert("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        console.error(e);
                    }
                },
                async collectDetail() {
                    if (!this.selectedApp) return;
                    this.isCollecting = true;
                    try {
                        const res = await fetch(`${API_BASE}/collect_detail?app_id=${this.selectedApp.id}`, {
                            method: 'POST'
                        });
                        const result = await res.json();

                        if (result.status === 'success') {
                            // Fetch updated info
                            const infoRes = await fetch(`${API_BASE}/viewappinfo?app_id=${this.selectedApp.id}`);
                            this.appDetailData = await infoRes.json();
                        } else {
                            alert("ìˆ˜ì§‘ ì‹¤íŒ¨: " + result.detail);
                        }
                    } catch (e) {
                        alert("API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        console.error(e);
                    } finally {
                        this.isCollecting = false;
                    }
                },
                openKeywordModal() {
                    this.selectedKeywords = [];
                    this.keywordSelectModalOpen = true;
                },
                toggleKeyword(kw) {
                    const idx = this.selectedKeywords.indexOf(kw);
                    if (idx > -1) {
                        this.selectedKeywords.splice(idx, 1);
                    } else {
                        if (this.selectedKeywords.length < 3) {
                            this.selectedKeywords.push(kw);
                        }
                    }
                },
                async startPipelineWithKeywords() {
                    this.keywordSelectModalOpen = false;
                    this.isRunningPipeline = true;

                    const payload = {};
                    if (this.selectedKeywords.length > 0) {
                        payload.keywords = this.selectedKeywords;
                    }
                    if (this.selectedCountries.length > 0) {
                        payload.countries = this.selectedCountries;
                    } else {
                        payload.countries = ['us']; // Default
                    }

                    try {
                        const res = await fetch(`${API_BASE}/run_pipeline`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: Object.keys(payload).length > 0 ? JSON.stringify(payload) : undefined
                        });
                        const result = await res.json();

                        if (res.ok && result.status === 'success') {
                            this.pollPipelineStatus();
                        } else {
                            alert("ì‹¤í–‰ ì‹¤íŒ¨: " + (result.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬"));
                            this.isRunningPipeline = false;
                        }
                    } catch (e) {
                        alert("API ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        console.error(e);
                        this.isRunningPipeline = false;
                    }
                },
                async openRunLogs() {
                    this.logModalOpen = true;
                    this.runLogData = "ë¡œê·¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
                    try {
                        const res = await fetch(`${API_BASE}/viewrunlogs?run_id=${this.selectedRunId}`);
                        const result = await res.json();
                        this.runLogData = result.log_output;
                    } catch (e) {
                        console.error("Failed to fetch run logs", e);
                        this.runLogData = "ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    }
                }
            }
        }).mount('#app')
    </script>
</body>

</html>