import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os
import logging
from datetime import datetime
from dotenv import load_dotenv

# Import local modules
from store_scraper import StoreScraper
from ai_analyzer import AIAnalyzer

load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

class AppMarketAgent:
    def __init__(self):
        self.store_scraper = StoreScraper()
        self.ai_analyzer = AIAnalyzer()
        
        self.smtp_server = os.getenv("SMTP_SERVER", "smtp.gmail.com")
        self.smtp_port = int(os.getenv("SMTP_PORT", 587))
        self.sender_email = os.getenv("SENDER_EMAIL")
        self.sender_password = os.getenv("SENDER_PASSWORD")
        self.recipient_email = "handrake99@gmail.com"

    def generate_report_content(self, store_results: list) -> str:
        report = f"## üìà ÏùºÏùº Ïú†Îßù Ïï± ÎßàÏºì Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ ({datetime.now().strftime('%Y-%m-%d')})\n\n"
        report += "Î≥∏ Î¶¨Ìè¨Ìä∏Îäî ÎãàÏπò ÎßàÏºì, ÏàòÏùµ Î™®Îç∏, 1Ïù∏ Í∞úÎ∞ú Í∞ÄÎä•ÏÑ±ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÌïÑÌÑ∞ÎßÅÎêú Ïû†Ïû¨Î†• ÎÜíÏùÄ Ïù∏Îîî iOS Ïï± Î™©Î°ùÏûÖÎãàÎã§.\n\n"
        
        report += "### üèÜ ÏóÑÏÑ†Îêú Ïú†Îßù ÌÉÄÍ≤ü Ïï±\n"
        if not store_results:
            report += "Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÎäî Ïï±Ïù¥ ÏóÜÏäµÎãàÎã§.\n\n"
        else:
            for i, result in enumerate(store_results, 1):
                app = result['app_metadata']
                eval_reason = result['evaluation_reason']
                report += f"{i}. **{app.get('title')}** (iOS)\n"
                report += f"   - URL: {app.get('url', 'N/A')}\n"
                report += f"   - Ï∂úÏ≤ò(Í≤ÄÏÉâ ÌÇ§ÏõåÎìú): {app.get('source_keyword', 'Unknown')}\n"
                report += f"   - ÏÑ§Î™Ö ÏöîÏïΩ: {app.get('description', '').replace(chr(10), ' ')[:150]}...\n"
                report += f"   - **ÏÑ†Ï†ï ÏÇ¨Ïú† (LLM ÌèâÍ∞Ä):**\n"
                report += f"     - ÎãàÏπò ÎßàÏºì: {eval_reason.get('niche_market', {}).get('reason', '')}\n"
                report += f"     - ÏàòÏùµ Î™®Îç∏: {eval_reason.get('revenue_model', {}).get('reason', '')}\n"
                report += f"     - Í∏∞Îä• Îã®ÏàúÏÑ±: {eval_reason.get('simplicity', {}).get('reason', '')}\n\n"
            
        report += "\n---\n*Generated by App Market Analyzer AI Agent*"
        return report

    def send_email_report(self, markdown_content: str):
        if not all([self.sender_email, self.sender_password]):
            logging.error("Email credentials not fully configured. Storing report to file instead.")
            with open("daily_report.md", "w") as f:
                f.write(markdown_content)
            logging.info("Report saved to daily_report.md")
            return

        msg = MIMEMultipart()
        msg['From'] = self.sender_email
        msg['To'] = self.recipient_email
        msg['Subject'] = f"[App Market Analyzer] ÏùºÏùº Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏ - {datetime.now().strftime('%Y-%m-%d')}"

        # You'd normally want to convert markdown to HTML here for better email formatting
        # For simplicity, we send it as plain text markdown
        msg.attach(MIMEText(markdown_content, 'plain'))

        try:
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.sender_email, self.sender_password)
            server.send_message(msg)
            server.quit()
            logging.info(f"Successfully sent email report to {self.recipient_email}")
        except Exception as e:
            logging.error(f"Failed to send email: {e}")
            with open("daily_report.md", "w") as f:
                f.write(markdown_content)

    def run(self):
        logging.info("Starting Daily App Market Analysis Cycle...")
        
        # We need a large initial pool since we are filtering them later
        target_store_apps = self.store_scraper.get_top_target_apps(max_pool_size=40)
        
        store_analysis_results = []
        
        # 2. Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è AI Î∂ÑÏÑù ÏÉùÎûµ (LLM Filter Evaluation Only)
        try:
            for app in target_store_apps:
                if len(store_analysis_results) >= 15:
                    break
                    
                # --- V3/V4: LLM Filter Evaluation Only ---
                evaluation = self.ai_analyzer.evaluate_app_potential(app)
                if not evaluation.get("is_approved", False):
                    logging.info(f"App {app.get('title')} rejected by LLM filter: {evaluation}")
                    continue
                
                logging.info(f"App {app.get('title')} approved by LLM filter!")
                
                store_analysis_results.append({
                    'app_metadata': app,
                    'evaluation_reason': evaluation
                })
                 
        except Exception as e:
            if "token/quota limits" in str(e):
                logging.error("üö® CRITICAL: LLM Token/Quota Limit Exceeded. Halting execution immediately. No email will be sent.")
                return # Abort the execution
            else:
                logging.error(f"Unexpected error during analysis loop: {e}")

        # 4. Î¶¨Ìè¨ÌåÖ
        report = self.generate_report_content(store_analysis_results)
        self.send_email_report(report)
        logging.info("Daily cycle completed.")

if __name__ == "__main__":
    agent = AppMarketAgent()
    agent.run()
